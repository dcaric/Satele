#!/bin/bash

# Satele CLI - The Remote Bridge Controller
# Usage:
#   satele start    - Start the bridge services
#   satele stop     - Stop the bridge services
#   satele name     - Set the trigger word (e.g. satele name mark)
#   satele status   - Check if services are running

BASE_DIR="$(cd "$(dirname "$0")" && pwd)"
PYTHON_CMD="python3"
NODE_CMD="node"
OS_TYPE=$(uname -s)

# Helper Functions
export REMOTE_BRIDGE_URL="http://localhost:8000"
export BRIDGE_SECRET_KEY="default-secret-key"

function update_env() {
    local KEY=$1
    local VAL=$2
    if [ ! -f "$BASE_DIR/satele_cfg.env" ]; then echo "$KEY=$VAL" > "$BASE_DIR/satele_cfg.env"; return; fi

    if grep -q "^$KEY=" "$BASE_DIR/satele_cfg.env"; then
        if [ "$OS_TYPE" == "Darwin" ]; then
            # macOS requires empty string for inplace no backup
            sed -i '' "s|^$KEY=.*|$KEY=$VAL|" "$BASE_DIR/satele_cfg.env"
        else
            # Linux (GNU sed) standard
            sed -i "s|^$KEY=.*|$KEY=$VAL|" "$BASE_DIR/satele_cfg.env"
        fi
    else
        # Append new
        echo "$KEY=$VAL" >> "$BASE_DIR/satele_cfg.env"
    fi
}

function get_env_var() {
    local KEY=$1
    local DEFAULT=$2
    if [ -f "$BASE_DIR/satele_cfg.env" ]; then
        local VAL=$(grep "^$KEY=" "$BASE_DIR/satele_cfg.env" | cut -d '=' -f2)
        if [ -z "$VAL" ]; then echo "$DEFAULT"; else echo "$VAL"; fi
    else
        echo "$DEFAULT"
    fi
}

function start() {
    echo "ü™ê Starting Satele Services..."
    cd "$BASE_DIR"

    # Cleanup Old Media
    mkdir -p media
    rm -f media/*

    # Load Config from satele_cfg.env to capture vars
    NAME="satele"
    if [ -f "$BASE_DIR/satele_cfg.env" ]; then
        set -a
        source "$BASE_DIR/satele_cfg.env"
        set +a
        if [ -n "$BOT_TRIGGER" ]; then NAME="$BOT_TRIGGER"; fi
    fi

    # 1. Start FastAPI Server
    if ! pgrep -f "Python server/main.py" > /dev/null; then
        source venv/bin/activate
        nohup python3 server/main.py >> /tmp/satele_dcaric.log 2>&1 &
        echo "‚úÖ FastAPI Server Started on Port 8000"
    else
        echo "‚úÖ FastAPI Server already running."
    fi

    # 2. Start WhatsApp Bridge
    if ! pgrep -f "node whatsapp_bridge.js" > /dev/null; then
        BOT_TRIGGER="$NAME" nohup node whatsapp_bridge.js >> /tmp/satele_dcaric.log 2>&1 &
        echo "‚úÖ WhatsApp Bridge Started"
    else
        echo "‚úÖ WhatsApp Bridge already running."
    fi

    # 3. Start AI Monitor
    if ! pgrep -f "monitor.py" > /dev/null; then
        source venv/bin/activate
        nohup python3 "$BASE_DIR/brain/monitor.py" >> /tmp/satele_dcaric.log 2>&1 &
        echo "‚úÖ AI Monitor (Brain) Started"
    else
        echo "‚úÖ AI Monitor already running."
    fi
    
    echo "‚úÖ Satele is now active in the background."
    echo "üìÑ Check logs with: tail -f /tmp/satele_dcaric.log"
}

function stop() {
    echo "üõë Stopping Satele Services..."
    pkill -f "Python server/main.py"
    pkill -f "node whatsapp_bridge.js"
    pkill -f "monitor.py"
    echo "‚úÖ All Satele processes terminated."
}

function set_name() {
    local NEW_NAME=$1
    if [ -z "$NEW_NAME" ]; then
        echo "‚ùå Usage: satele name <new_name>"
        exit 1
    fi
    
    # Update satele_cfg.env file
    if [ -f "$BASE_DIR/satele_cfg.env" ]; then
        if grep -q "BOT_TRIGGER=" "$BASE_DIR/satele_cfg.env"; then
            # Replace existing
            sed -i '' "s/BOT_TRIGGER=.*/BOT_TRIGGER=$NEW_NAME/" "$BASE_DIR/satele_cfg.env"
        else
            # Append new
            echo "BOT_TRIGGER=$NEW_NAME" >> "$BASE_DIR/satele_cfg.env"
        fi
        echo "‚úÖ Trigger name updated to: $NEW_NAME"
        echo "üîÑ Note: You must restart satele (stop/start) to apply the change."
    else
        echo "‚ùå satele_cfg.env file not found. Run start first."
    fi
}

function status() {
    echo "üìä Satele Status:"
    
    # Check Processes
    if lsof -i :8000 > /dev/null; then echo "üîπ FastAPI: RUNNING"; else echo "üî∏ FastAPI: STOPPED"; fi
    if pgrep -f "whatsapp_bridge.js" > /dev/null; then echo "üîπ WhatsApp Bridge: RUNNING"; else echo "üî∏ WhatsApp Bridge: STOPPED"; fi
    if pgrep -f "monitor.py" > /dev/null; then echo "üîπ AI Monitor: RUNNING"; else echo "üî∏ AI Monitor: STOPPED"; fi

    # Get AI Provider and Model
    local AI_PROVIDER=$(get_env_var "AI_PROVIDER" "gemini")
    local GEMINI_MODEL=$(get_env_var "GEMINI_MODEL" "gemini-2.0-flash")
    local OLLAMA_MODEL=$(get_env_var "OLLAMA_MODEL" "gemma:2b")

    local BRAIN_STATUS=""
    if [ "$AI_PROVIDER" = "ollama" ]; then
        BRAIN_STATUS="üß† Brain: Local (Ollama: $OLLAMA_MODEL)"
    elif [ "$AI_PROVIDER" = "gemini" ]; then
        # Check token usage if Gemini is active
        local TOKEN_INFO=""
        if [ -f "token_usage.json" ]; then
            local TOTAL=$(grep -o '"total": [0-9]*' token_usage.json | cut -d ' ' -f2)
            local IN=$(grep -o '"in": [0-9]*' token_usage.json | cut -d ' ' -f2)
            local OUT=$(grep -o '"out": [0-9]*' token_usage.json | cut -d ' ' -f2)
            
            # Cost calc
            local P_IN=$(get_env_var "GEMINI_PRICE_IN" "0")
            local P_OUT=$(get_env_var "GEMINI_PRICE_OUT" "0")
            
            # Simple bash float math (using awk)
            local COST=$(awk "BEGIN {printf \"%.4f\", ($IN/1000000 * $P_IN) + ($OUT/1000000 * $P_OUT)}")
            
            TOKEN_INFO=" | Tokens: ${TOTAL} (\$${COST})"
        else
             TOKEN_INFO=" | Tokens: 0 (\$0.00)"
        fi
        BRAIN_STATUS="üß† Brain: Cloud (Gemini: $GEMINI_MODEL)${TOKEN_INFO}"
    else
        BRAIN_STATUS="üß† Brain: Unknown"
    fi
    echo "$BRAIN_STATUS"
    
    # Memory Check
    if [ -d "$BASE_DIR/brain/satele_memory" ]; then
        # Use python to get count (might take ~1s)
        if [ -d "$BASE_DIR/venv" ]; then source "$BASE_DIR/venv/bin/activate" >/dev/null 2>&1; fi
        # Cd to BASE_DIR/brain to run python script correctly
        local MEM_COUNT=$(cd "$BASE_DIR/brain" && python3 memory.py status 2>/dev/null)
        echo "üìö Memory: Active ($MEM_COUNT records)"
    else
        echo "üìö Memory: Empty/Not Instantiated"
    fi
    echo ""
}

function memory_status() {
    echo "üß† Satele Long-Term Memory Inspection"
    cd "$BASE_DIR/brain"
    if [ -d "satele_memory" ]; then
        echo "üìÇ DB Path: $BASE_DIR/brain/satele_memory"
        if [ -d "$BASE_DIR/venv" ]; then source "$BASE_DIR/venv/bin/activate"; fi
        echo "‚è≥ Calculating stats..."
        local COUNT=$(python3 memory.py status)
        echo "üìä Total Embeddings: $COUNT"
        echo "üí° Tip: Memory grows automatically with every interaction."
    else
        echo "üî∏ Memory database not found."
        echo "   (It will be created automatically on first AI interaction)"
    fi
}

function whatsapp_link() {
    echo "üì± Starting WhatsApp Linking Process..."
    echo "üí° Instruction: Scan the QR code below with your WhatsApp ('Linked Devices')"
    echo "‚ö†Ô∏è  Note: This will stop any running Satele services first."
    stop
    
    # Clear old session to force new QR code
    if [ -d "$BASE_DIR/.mudslide_cache" ]; then
        echo "üßπ Clearing old session cache..."
        rm -rf "$BASE_DIR/.mudslide_cache"
    fi

    # Run interactively so we see the QR code
    cd "$BASE_DIR"
    node whatsapp_bridge.js
}

function set_gemini_key() {
    local NEW_KEY=$1
    if [ -z "$NEW_KEY" ]; then
        echo "‚ùå Usage: satele geminikey <your_api_key>"
        exit 1
    fi

    # Check if satele_cfg.env exists, if not create from example
    if [ ! -f "$BASE_DIR/satele_cfg.env" ]; then
        if [ -f "$BASE_DIR/satele_cfg.env.example" ]; then
            cp "$BASE_DIR/satele_cfg.env.example" "$BASE_DIR/satele_cfg.env"
            echo "üìù Created satele_cfg.env from satele_cfg.env.example"
        else
            echo "‚ö†Ô∏è  satele_cfg.env.example not found, creating new satele_cfg.env"
            echo "REMOTE_BRIDGE_URL=http://localhost:8000" > "$BASE_DIR/satele_cfg.env"
            echo "BRIDGE_SECRET_KEY=default-secret-key" >> "$BASE_DIR/satele_cfg.env"
            echo "BOT_TRIGGER=satele" >> "$BASE_DIR/satele_cfg.env"
        fi
    fi
    
    # Update or Add GOOGLE_API_KEY
    if grep -q "GOOGLE_API_KEY=" "$BASE_DIR/satele_cfg.env"; then
        # Replace existing key (using a temp file strategy for cross-platform compat)
        sed "s|GOOGLE_API_KEY=.*|GOOGLE_API_KEY=$NEW_KEY|" "$BASE_DIR/satele_cfg.env" > "$BASE_DIR/satele_cfg.env.tmp" && mv "$BASE_DIR/satele_cfg.env.tmp" "$BASE_DIR/satele_cfg.env"
        echo "‚úÖ Updated existing GOOGLE_API_KEY."
    else
        # Append new key
        echo "GOOGLE_API_KEY=$NEW_KEY" >> "$BASE_DIR/satele_cfg.env"
        echo "‚úÖ Added new GOOGLE_API_KEY."
    fi
    
    echo "üîÑ Note: You must restart satele (stop/start) to apply the change."
}

function install_skill_globally() {
    local GLOBAL_SKILL_DIR="$HOME/satele_global"
    echo "üåç Installing Satele Skill globally to $GLOBAL_SKILL_DIR..."
    
    mkdir -p "$GLOBAL_SKILL_DIR"
    # Copy the local .agent folder to the global location
    if [ -d "$BASE_DIR/.agent" ]; then
         cp -r "$BASE_DIR/.agent/"* "$GLOBAL_SKILL_DIR/"
         echo "‚úÖ Satele Skill installed globally."
    else
         echo "‚ö†Ô∏è  Could not find local .agent folder in $BASE_DIR."
         return 1
    fi
}

function link_project() {
    local TARGET_DIR=$(pwd)
    local GLOBAL_SKILL_DIR="$HOME/satele_global"
    
    echo "üîó Linking Satele capability to current project: $TARGET_DIR"
    
    if [ ! -d "$GLOBAL_SKILL_DIR" ]; then
        echo "‚ùå Satele Skill not found globally. Run 'satele install' first."
        return 1
    fi
    
    # Create .agent structure if missing
    mkdir -p "$TARGET_DIR/.agent/skills"
    mkdir -p "$TARGET_DIR/.agent/workflows"
    
    # Symlink the Skills
    ln -sf "$GLOBAL_SKILL_DIR/skills/satele_control" "$TARGET_DIR/.agent/skills/"
    echo "   - Linked Skill: satele_control"
    
    # Symlink the Workflows
    ln -sf "$GLOBAL_SKILL_DIR/workflows/satele.md" "$TARGET_DIR/.agent/workflows/satele.md"
    echo "   - Linked Workflow: /satele"
    
    echo "‚úÖ Project Linked! You can now use '/satele' in this workspace."
}

function set_token_prices() {
    local PRICE_IN=$1
    local PRICE_OUT=$2
    
    if [ -z "$PRICE_IN" ] || [ -z "$PRICE_OUT" ]; then
        echo "‚ùå Usage: satele tokens <price_in_per_1M> <price_out_per_1M>"
        echo "üí° Example (Gemini 3 Flash): satele tokens 0.50 3.00"
        return 1
    fi
    
    update_env "GEMINI_PRICE_IN" "$PRICE_IN"
    update_env "GEMINI_PRICE_OUT" "$PRICE_OUT"
    echo "‚úÖ Token prices updated."
    echo "üì• Input Price: \$$PRICE_IN / 1M tokens"
    echo "üì§ Output Price: \$$PRICE_OUT / 1M tokens"
}

function set_gemini_model() {
    local MODEL=$1
    if [ -z "$MODEL" ]; then
        echo "‚ùå Usage: satele gemini <model_name>"
        echo "üí° Examples: gemini-3-flash-preview, gemini-2.0-flash"
        return 1
    fi
    update_env "GEMINI_MODEL" "$MODEL"
    update_env "AI_PROVIDER" "gemini"
    echo "‚úÖ Switched to Cloud Gemini: $MODEL"
    echo "üîÑ Please restart Satele services: 'satele stop && satele start'"
}

function add_number() {
    local NUM=$1
    if [ -z "$NUM" ]; then echo "‚ùå Usage: satele add-number <mobile_number> (e.g. 38591...)"; return 1; fi
    
    # Clean number (remove + and spaces)
    NUM=$(echo "$NUM" | tr -d '+ ')
    
    CURRENT=$(grep "^ALLOWED_NUMBERS=" "$BASE_DIR/satele_cfg.env" | cut -d= -f2)
    if [ -z "$CURRENT" ]; then
        update_env "ALLOWED_NUMBERS" "$NUM"
    else
        # Check if exists
        if [[ ",$CURRENT," == *",$NUM,"* ]]; then
            echo "‚úÖ Number $NUM is already allowed."
            return
        fi
        update_env "ALLOWED_NUMBERS" "$CURRENT,$NUM"
    fi
    echo "‚úÖ Added $NUM to allowed list."
    echo "üîÑ Please restart Satele to apply."
}

function remove_number() {
    local NUM=$1
    if [ -z "$NUM" ]; then echo "‚ùå Usage: satele remove-number <mobile_number>"; return 1; fi
    NUM=$(echo "$NUM" | tr -d '+ ')
    
    CURRENT=$(grep "^ALLOWED_NUMBERS=" "$BASE_DIR/satele_cfg.env" | cut -d= -f2)
    # Remove number from comma list
    # Logic: convert commas to newlines, grep -v, paste back
    NEW=$(echo "$CURRENT" | tr ',' '\n' | grep -v "^$NUM$" | paste -sd, -)
    
    update_env "ALLOWED_NUMBERS" "$NEW"
    echo "‚úÖ Removed $NUM from allowed list."
    echo "üîÑ Please restart Satele to apply."
}

function list_numbers() {
    CURRENT=$(grep "^ALLOWED_NUMBERS=" "$BASE_DIR/satele_cfg.env" | cut -d= -f2)
    if [ -z "$CURRENT" ]; then
        echo "üì≠ No extra numbers allowed (Only 'Me' is allowed by default)."
    else
        echo "üìã Allowed Numbers:"
        echo "$CURRENT" | tr ',' '\n' | sed 's/^/- /'
    fi
}

function ollama_mgr() {
    local SUB_CMD=$1
    local EXTRA_ARG=$2
    
    cd "$BASE_DIR"

    case "$SUB_CMD" in
        "")
            # Default: check/install
            echo "ü¶ô Checking Ollama installation..."
            if ! command -v ollama &> /dev/null; then
                echo "‚ùå Ollama not found. Attempting to install..."
                if command -v brew &> /dev/null; then
                    echo "üì¶ Installing via Homebrew..."
                    brew install ollama
                else
                    echo "üì¶ Installing via install.sh..."
                    curl -fsSL https://ollama.com/install.sh | sh
                fi
                
                if command -v ollama &> /dev/null; then
                    echo "‚úÖ Ollama installed successfully!"
                    echo "‚ö†Ô∏è  You may need to run 'ollama serve' in a separate terminal if the service doesn't start automatically."
                else
                    echo "‚ùå Installation failed. Please install Ollama manually: https://ollama.com/"
                    exit 1
                fi
            else
                echo "‚úÖ Ollama is already installed."
                ollama --version
            fi
            ;;
            
        start)
            update_env "AI_PROVIDER" "ollama"
            echo "‚úÖ Switched AI Provider to: Local Ollama"
            echo "üîÑ Please restart Satele services: 'satele stop && satele start'"
            ;;
            
        stop)
            update_env "AI_PROVIDER" "gemini"
            echo "‚úÖ Switched AI Provider to: Cloud Gemini"
            echo "üîÑ Please restart Satele services: 'satele stop && satele start'"
            ;;
            
        *)
            # Assume it's a model name (e.g. gemma3:4b)
            MODEL_NAME=$SUB_CMD
            
            if ! command -v ollama &> /dev/null; then
                echo "‚ùå Ollama not installed. Run 'satele ollama' first."
                exit 1
            fi

            # Check if model already exists locally
            if ollama list | grep -q "$MODEL_NAME"; then
                echo "‚úÖ Model '$MODEL_NAME' found locally. Skipping download."
            else
                echo "‚¨áÔ∏è  Pulling base model: $MODEL_NAME..."
                if ! ollama pull "$MODEL_NAME"; then
                    echo "‚ùå Failed to pull model '$MODEL_NAME'. Check model name."
                    exit 1
                fi
            fi
            
            # Create Custom Modelfile
            BOT_NAME=$(get_env_var "BOT_TRIGGER" "satele")
            # Ensure bot name is lowercase/safe for model name
            SAFE_BOT_NAME=$(echo "$BOT_NAME" | tr '[:upper:]' '[:lower:]' | tr -cd '[:alnum:]_-')
            CUSTOM_MODEL_NAME="satele-${SAFE_BOT_NAME}"
            
            echo "üõ†Ô∏è  Creating custom model '$CUSTOM_MODEL_NAME' based on $MODEL_NAME..."
            
            cat <<EOF > Modelfile
FROM $MODEL_NAME
SYSTEM "You are $BOT_NAME, a helpful AI assistant connected to a Mac terminal. You verify commands before executing. Respond with safe bash commands, ONE PER LINE. NO HTML."
EOF
            if ollama create "$CUSTOM_MODEL_NAME" -f Modelfile; then
                rm Modelfile
                update_env "OLLAMA_MODEL" "$CUSTOM_MODEL_NAME"
                echo "‚úÖ Custom model '$CUSTOM_MODEL_NAME' created and set as default."
                echo "üí° To use it, run: 'satele ollama start'"
            else
                echo "‚ùå Failed to create custom model."
                rm Modelfile
                exit 1
            fi
            ;;
    esac
}

function setup() {
    echo "üõ†Ô∏è  Setting up Satele Dependencies..."
    cd "$BASE_DIR"

    # 1. Node.js (Bridge)
    if [ -f "package.json" ]; then
        echo "üì¶ Installing Node.js packages..."
        npm install --silent
    fi
    
    # 2. Python (Brain)
    if [ ! -d "venv" ]; then
        echo "üêç Creating Python Virtual Environment..."
        python3 -m venv venv
    fi
    
    echo "üì¶ Installing Python packages..."
    source venv/bin/activate
    
    # Upgrade pip first to handle modern packages better
    pip install --upgrade pip --quiet
    
    # Use extended timeout for heavy packages like chromadb
    pip install --default-timeout=100 -r requirements.txt --quiet
    
    echo "‚úÖ Setup Complete! You can now run 'satele start'."
}

function help() {
    echo "ü™ê Satele CLI - The Remote Bridge Controller"
    echo ""
    echo "Usage: satele <command> [arguments]"
    echo ""
    echo "Commands:"
    echo "  setup               Install dependencies (Node.js & Python)"
    echo "  start               Start the bridge services in the background"
    echo "  stop                Stop all running bridge services"
    echo "  status              Check if services are running"
    echo "  kill                Force kill all related processes"
    echo "  name <name>         Set the bot's trigger name (default: satele)"
    echo "  tokens <in> <out>   Set pricing for Gemini (e.g. 0.50 3.00)"
    echo "  gemini <model>      Switch Gemini model (e.g. gemini-3-flash-preview)"
    echo "  add-number <num>    Whitelist a number (e.g. 38591...)"
    echo "  remove-number <n>   Remove number from whitelist"
    echo "  users               Show allowed numbers"
    echo "  memory              Show long-term memory status"
    echo "  ollama [model]      Manage local AI (e.g. 'satele ollama gemma3:4b')"
    echo "  ollama start        Switch to Local Ollama mode"
    echo "  ollama stop         Switch back to Cloud Gemini mode"
    echo "  whatsapp            Launch interactive mode to link a device via QR code"
    echo "  setup-sudo          Enable passwordless sudo (Optional, use with caution)"
    echo "  install             Install the connection skill globally (for IDE)"
    echo "  link                Enable remote control in the current project"
    echo "  help                Show this message"
    echo ""
    echo "Logs:"
    echo "  tail -f $BASE_DIR//tmp/satele_dcaric.log"
}

# Command Router
case "$1" in
    setup)
        setup
        ;;
    start)
        start
        ;;
    stop)
        stop
        ;;
    kill)
        pkill -f "Python server/main.py"
        pkill -f "node whatsapp_bridge.js"
        pkill -f "monitor.py"
        echo "üíÄ Force killed all processes."
        ;;
    ollama)
        ollama_mgr "$2"
        ;;
    gemini)
        set_gemini_model "$2"
        ;;
    add-number)
        add_number "$2"
        ;;
    remove-number)
        remove_number "$2"
        ;;
    list-numbers)
        list_numbers
        ;;
    users)
        list_numbers
        ;;
    memory)
        memory_status
        ;;
    tokens)
        set_token_prices "$2" "$3"
        ;;
    name)
        set_name "$2"
        ;;
    geminikey)
        set_gemini_key "$2"
        ;;
    install)
        install_skill_globally
        ;;
    link)
        link_project
        ;;
    status)
        status
        ;;
    whatsapp)
        whatsapp_link
        ;;
    help|--help|-h)
        help
        ;;
    setup-sudo)
        echo "üîê Starting sudo configuration..."
        sudo "$BASE_DIR/setup_sudo.sh"
        ;;
    *)
        help
        exit 1
        ;;
esac
